<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo Ciacollor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
        .product-card { transition: all 0.2s ease-in-out; }
        .product-card:active { transform: scale(0.98); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

    <header class="bg-white/90 backdrop-blur-md border-b sticky top-0 z-40 px-4 py-3 shadow-sm">
        <div class="container mx-auto max-w-lg">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-blue-900 rounded-lg flex items-center justify-center text-white font-black italic text-xs">C</div>
                    <span class="font-bold text-slate-800 text-xl tracking-tight italic">Ciacollor</span>
                </div>
                <div id="counter" class="bg-slate-100 text-slate-500 text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-wider">
                    Cargando...
                </div>
            </div>

            <div class="relative group">
                <input type="text" id="searchInput" placeholder="Buscar producto..." 
                       class="w-full bg-slate-100 border-none rounded-2xl py-3 pl-11 pr-4 text-slate-700 font-medium focus:ring-2 focus:ring-blue-500 outline-none">
                <i class="fas fa-search absolute left-4 top-3.5 text-slate-400"></i>
            </div>

            <div class="flex gap-2 mt-3 overflow-x-auto no-scrollbar pb-1">
                <button onclick="filterBy('all')" class="filter-btn active bg-slate-800 text-white px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap">Todo</button>
                <button onclick="filterBy('Emborrachada')" class="filter-btn bg-slate-100 text-slate-500 px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap">Emborrachada</button>
                <button onclick="filterBy('Al Agua')" class="filter-btn bg-slate-100 text-slate-500 px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap">Al Agua</button>
                <button onclick="filterBy('Sintético')" class="filter-btn bg-slate-100 text-slate-500 px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap">Metales/Madera</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto max-w-lg p-4 pb-24">
        <div id="catalogGrid" class="flex flex-col gap-3">
            <div class="animate-pulse space-y-3">
                <div class="h-24 bg-slate-200 rounded-2xl"></div>
                <div class="h-24 bg-slate-200 rounded-2xl"></div>
            </div>
        </div>
    </main>

    <div id="productModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>

        <div class="absolute bottom-0 md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 w-full md:w-[450px] h-[90vh] md:h-auto bg-white md:rounded-3xl rounded-t-3xl shadow-2xl flex flex-col overflow-hidden transition-transform transform translate-y-full md:translate-y-0" id="modalPanel">
            
            <button onclick="closeModal()" class="absolute top-4 right-4 z-10 w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 hover:bg-slate-200">
                <i class="fas fa-times"></i>
            </button>

            <div class="overflow-y-auto p-6 pb-32 no-scrollbar flex-1">
                <div class="flex justify-between items-start mb-2">
                    <p id="m-sku" class="text-[10px] font-black text-slate-300 uppercase tracking-widest">ID: ---</p>
                    <span id="m-tag" class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-[10px] font-bold uppercase">---</span>
                </div>
                
                <h2 id="m-title" class="text-2xl font-black text-slate-800 leading-tight mb-4">---</h2>

                <div id="m-variants-container" class="flex flex-wrap gap-2 mb-6">
                    </div>
                
                <div class="bg-slate-50 rounded-2xl p-6 mb-6 border border-slate-100 flex justify-center relative">
                    <img id="m-img" src="" class="h-48 object-contain drop-shadow-xl transition-all duration-300" onerror="this.src='https://via.placeholder.com/300?text=Sin+Imagen'">
                </div>

                <div class="mb-6">
                    <h3 class="text-xs font-bold text-slate-900 uppercase mb-2 flex items-center gap-2">
                        <i class="fas fa-info-circle text-blue-500"></i> Descripción
                    </h3>
                    <p id="m-desc" class="text-sm text-slate-500 leading-relaxed">---</p>
                </div>

                <div class="bg-blue-50 rounded-xl p-4 border border-blue-100 transition-all duration-300">
                    <h3 class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-1">Rendimiento Técnico (Cubritivo)</h3>
                    <p id="m-rendimiento" class="text-sm font-bold text-blue-900 flex items-start gap-2">
                        <i class="fas fa-fill-drip mt-1 opacity-50"></i>
                        <span>---</span>
                    </p>
                    <p id="m-secado" class="text-[10px] font-bold text-blue-400 mt-2 text-right">---</p>
                </div>
            </div>

            <div class="absolute bottom-0 left-0 right-0 bg-white border-t p-4 flex items-center justify-between shadow-[0_-10px_40px_rgba(0,0,0,0.05)]">
                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Precio Lista</p>
                    <p id="m-price" class="text-3xl font-black text-slate-800 tracking-tight">---</p>
                </div>
                <a href="#" id="m-whatsapp" target="_blank" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg shadow-green-200 transition-all active:scale-95">
                    <i class="fab fa-whatsapp text-lg"></i> Consultar
                </a>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let db = JSON.parse(localStorage.getItem('ciacollor_db')) || {};

        async function loadCatalog() {
            try {
                const response = await fetch('data.json'); 
                const rawData = await response.json();
                
                allData = [];
                rawData.forEach(product => {
                    const text = (product.nombre + product.descripcion).toLowerCase();
                    let category = 'Al Agua';
                    if (text.includes('ciaflex') || text.includes('emborrachada')) category = 'Emborrachada';
                    else if (text.includes('sintético') || text.includes('solvente')) category = 'Sintético';

                    product.variantes.forEach(variant => {
                        allData.push({
                            parent: product, // Guardamos el padre completo para acceder a los hermanos
                            variant: variant,
                            sku: variant.sku_id,
                            category: category,
                            fullName: `${product.nombre} ${variant.medida}`,
                            price: db[variant.sku_id]?.price || "0.00",
                            stock: db[variant.sku_id]?.stock ?? true
                        });
                    });
                });
                renderCatalog();
            } catch (error) {
                console.error(error);
                document.getElementById('catalogGrid').innerHTML = '<p class="text-center text-red-400 py-10">Error cargando catálogo.</p>';
            }
        }

        function renderCatalog(filter = 'all', search = '') {
            const grid = document.getElementById('catalogGrid');
            grid.innerHTML = '';
            
            let filtered = allData.filter(item => {
                if (filter !== 'all' && item.category !== filter) return false;
                if (search && !item.fullName.toLowerCase().includes(search.toLowerCase()) && !item.sku.toString().includes(search)) return false;
                return true;
            });

            document.getElementById('counter').innerText = `${filtered.length} PRODS`;

            filtered.forEach(item => {
                const badgeColor = item.category === 'Emborrachada' ? 'bg-purple-100 text-purple-600' : 
                                   item.category === 'Sintético' ? 'bg-orange-100 text-orange-600' : 'bg-blue-100 text-blue-600';
                const opacity = item.stock ? 'opacity-100' : 'opacity-60 grayscale';

                const card = document.createElement('div');
                card.className = `product-card bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4 cursor-pointer ${opacity}`;
                // Pasamos el item completo a openModal
                card.onclick = () => openModal(item); 

                card.innerHTML = `
                    <div class="w-20 h-20 bg-slate-50 rounded-xl flex-shrink-0 flex items-center justify-center p-2 relative">
                        <img src="imagenes/${item.sku}.jpg" onerror="this.src='https://via.placeholder.com/150?text=IMG'" class="max-h-full object-contain mix-blend-multiply">
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[9px] font-black uppercase px-2 py-0.5 rounded-full ${badgeColor}">${item.category}</span>
                            <span class="text-[9px] font-bold text-slate-300">#${item.sku}</span>
                        </div>
                        <h3 class="font-bold text-slate-700 text-sm leading-tight truncate">${item.fullName}</h3>
                        ${!item.stock ? '<span class="text-[10px] font-bold text-red-500 uppercase">Sin Stock</span>' : ''}
                    </div>
                    <div class="text-right">
                         <span class="block text-xs font-bold text-slate-400 mb-1">Precio</span>
                         <span class="block text-lg font-black text-slate-800 tracking-tight">$${item.price}</span>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // LÓGICA DEL MODAL CON BOTONES
        let currentParent = null; // Para recordar el producto padre actual

        function openModal(item) {
            currentParent = item.parent; // Guardamos el padre para buscar hermanos
            updateModalContent(item.variant); // Iniciamos con la variante clickeada
            
            const modal = document.getElementById('productModal');
            const panel = document.getElementById('modalPanel');
            modal.classList.remove('hidden');
            setTimeout(() => { panel.classList.remove('translate-y-full'); }, 10);
        }

        // Función auxiliar que actualiza todo el contenido del modal
        function updateModalContent(variant) {
            const sku = variant.sku_id;
            const price = db[sku]?.price || "0.00";
            
            // 1. Textos Básicos
            document.getElementById('m-sku').innerText = `SKU: ${sku}`;
            document.getElementById('m-title').innerText = `${currentParent.nombre}`;
            document.getElementById('m-desc').innerText = currentParent.descripcion;
            document.getElementById('m-tag').innerText = currentParent.categoria; // Usamos categoria original del JSON

            // 2. Datos Técnicos Variables
            document.getElementById('m-rendimiento').innerHTML = `<span>${variant.rendimiento}</span>`;
            document.getElementById('m-secado').innerText = `Secado: ${variant.secado}`;
            document.getElementById('m-price').innerText = `$ ${price}`;
            
            // 3. Imagen
            const img = document.getElementById('m-img');
            img.style.opacity = '0'; // Efecto fade
            setTimeout(() => {
                img.src = `imagenes/${sku}.jpg`;
                img.style.opacity = '1';
            }, 150);

            // 4. GENERAR BOTONES DE TAMAÑO
            const container = document.getElementById('m-variants-container');
            container.innerHTML = ''; // Limpiar botones anteriores

            currentParent.variantes.forEach(v => {
                const btn = document.createElement('button');
                const isSelected = v.sku_id === sku;
                
                // Estilos: Si está seleccionado es Azul Oscuro, si no, es Gris claro
                btn.className = `px-4 py-2 rounded-lg text-xs font-bold border transition-all ${
                    isSelected 
                    ? 'bg-slate-800 text-white border-slate-800 shadow-md transform scale-105' 
                    : 'bg-white text-slate-500 border-slate-200 hover:border-slate-400'
                }`;
                btn.innerText = v.medida;
                
                // Al hacer clic, actualizamos la vista con ESTA variante
                btn.onclick = () => updateModalContent(v);
                
                container.appendChild(btn);
            });

            // 5. Link WhatsApp Actualizado
            const msg = `Hola, me interesa: ${currentParent.nombre} - ${variant.medida} (SKU: ${sku})`;
            document.getElementById('m-whatsapp').href = `https://wa.me/595999999999?text=${encodeURIComponent(msg)}`;
        }

        function closeModal() {
            const modal = document.getElementById('productModal');
            const panel = document.getElementById('modalPanel');
            panel.classList.add('translate-y-full');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        function filterBy(cat) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if(btn.innerText.includes(cat) || (cat === 'all' && btn.innerText === 'Todo')) {
                    btn.classList.add('bg-slate-800', 'text-white');
                    btn.classList.remove('bg-slate-100', 'text-slate-500');
                } else {
                    btn.classList.remove('bg-slate-800', 'text-white');
                    btn.classList.add('bg-slate-100', 'text-slate-500');
                }
            });
            renderCatalog(cat, document.getElementById('searchInput').value);
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            renderCatalog('all', e.target.value);
        });

        loadCatalog();
    </script>
</body>
</html>
